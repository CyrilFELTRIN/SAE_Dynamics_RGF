@page
@model SAE_Dynamics_RGF.Pages.ProductDetailModel
@using Microsoft.AspNetCore.Http
@{ 
    ViewData["Title"] = "Détails du produit";
}

<style>
.btn-icon {
    width: 48px;
    height: 48px;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-size: 1.1rem;
    transition: all 0.2s ease-in-out;
}

.btn-icon:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.btn-icon i {
    margin: 0;
}
</style>

<section class="py-4 py-lg-5 bg-body-tertiary">
    <div class="container">
        <nav class="mb-3" aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="/" class="text-decoration-none" data-lang-fr="Accueil" data-lang-en="Home">Accueil</a></li>
                <li class="breadcrumb-item"><a href="/Products" class="text-decoration-none" data-lang-fr="Produits" data-lang-en="Products">Produits</a></li>
                <li class="breadcrumb-item active" aria-current="page" data-lang-fr="Détails" data-lang-en="Details">Détails</li>
            </ol>
        </nav>

        @if (Model.Product == null)
        {
            <div class="text-center py-5">
                <div class="mx-auto mb-3 d-flex align-items-center justify-content-center rounded-circle bg-primary bg-opacity-10 text-primary"
                     style="width: 64px; height: 64px;">
                    <i class="fas fa-circle-exclamation"></i>
                </div>
                <h1 class="h4 fw-bold mb-2" data-lang-fr="Produit non trouvé" data-lang-en="Product not found">Produit non trouvé</h1>
                <p class="text-muted mb-0" data-lang-fr="Le produit demandé n'existe pas ou n'est plus disponible." data-lang-en="The requested product doesn't exist or is no longer available.">
                    Le produit demandé n'existe pas ou n'est plus disponible.
                </p>
                <div class="mt-4">
                    <a href="/Products" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>
                        <span data-lang-fr="Retour au catalogue" data-lang-en="Back to catalog">Retour au catalogue</span>
                    </a>
                </div>
            </div>
        }
        else
        {
            <div class="row g-4 g-lg-5 align-items-start">
                <div class="col-lg-6">
                    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                        <div class="ratio ratio-4x3 bg-body-tertiary">
                            <img src="@Model.Product.ImageUrl" class="w-100 h-100" alt="@Model.Product.Name" style="object-fit: cover;">
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="d-flex align-items-start justify-content-between gap-3 mb-3">
                        <div>
                            <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill mb-2 d-inline-block"
                                  data-lang-fr="Détails produit"
                                  data-lang-en="Product details">
                                Détails produit
                            </span>
                            <h1 class="display-6 fw-bold mb-1">@Model.Product.Name</h1>
                            <div class="text-muted" data-lang-fr="Informations issues de Dataverse" data-lang-en="Information from Dataverse">Informations issues de Dataverse</div>
                            <div class="mt-2 h5 fw-bold product-price" data-price-eur="@(Model.Product.PriceEur?.ToString("F2", System.Globalization.CultureInfo.InvariantCulture) ?? "")" data-price-chf="@(Model.Product.PriceChf?.ToString("F2", System.Globalization.CultureInfo.InvariantCulture) ?? "")" style="display:none;"></div>
                        </div>
                        <a href="/Products" class="btn btn-outline-primary d-none d-sm-inline-flex align-items-center">
                            <i class="fas fa-arrow-left me-2"></i>
                            <span data-lang-fr="Retour" data-lang-en="Back">Retour</span>
                        </a>
                    </div>

                    <div class="card border-0 shadow-sm rounded-4">
                        <div class="card-body p-4">
                            @if (!string.IsNullOrWhiteSpace(Model.QuoteErrorMessage))
                            {
                                <div class="alert alert-danger mb-3" role="alert">
                                    @Model.QuoteErrorMessage
                                </div>
                            }

                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-barcode text-muted me-2"></i>
                                        <div>
                                            <div class="text-muted small" data-lang-fr="Numéro du produit" data-lang-en="Product number">Numéro du produit</div>
                                            <div class="fw-semibold">@Model.ProductNumber</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-tag text-muted me-2"></i>
                                        <div>
                                            <div class="text-muted small" data-lang-fr="Catégorie" data-lang-en="Category">Catégorie</div>
                                            <div class="fw-semibold">@Model.Product.Category</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-center gap-2 mt-4">
                                <a href="/Products" class="btn btn-outline-primary btn-icon" title="Retour au catalogue">
                                    <i class="fas fa-arrow-left"></i>
                                </a>
                                @if (HttpContext.Session.GetString("IsLoggedIn") == "true")
                                {
                                    <button type="button" class="btn btn-outline-danger btn-icon" data-bs-toggle="modal" data-bs-target="#savProductModal" title="Demande SAV">
                                        <i class="fas fa-screwdriver-wrench"></i>
                                    </button>
                                }
                                else
                                {
                                    <a class="btn btn-outline-danger btn-icon" asp-page="/Login" asp-route-ReturnUrl="@($"{HttpContext.Request.Path}{HttpContext.Request.QueryString}")" title="Demande SAV">
                                        <i class="fas fa-screwdriver-wrench"></i>
                                    </a>
                                }
                                @if (HttpContext.Session.GetString("IsLoggedIn") == "true")
                                {
                                    <button type="button" class="btn btn-primary btn-icon" data-bs-toggle="modal" data-bs-target="#requestQuoteModal" title="Demander un devis">
                                        <i class="fas fa-cart-shopping"></i>
                                    </button>
                                }
                                else
                                {
                                    <a class="btn btn-primary btn-icon" asp-page="/Login" asp-route-ReturnUrl="@($"{HttpContext.Request.Path}{HttpContext.Request.QueryString}")" title="Demander un devis">
                                        <i class="fas fa-cart-shopping"></i>
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="requestQuoteModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" data-lang-fr="Demander un devis" data-lang-en="Request a quote">Demander un devis</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form method="post" asp-page-handler="RequestQuote">
                            <div class="modal-body">
                                <input type="hidden" asp-for="ProductNumber" />

                                <div class="mb-3">
                                    <label class="form-label" data-lang-fr="Rubrique" data-lang-en="Subject">Rubrique</label>
                                    <input class="form-control" asp-for="QuoteRubrique" required />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label" data-lang-fr="Description" data-lang-en="Description">Description</label>
                                    <textarea class="form-control" asp-for="QuoteDescription" rows="3"></textarea>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label" data-lang-fr="Devise" data-lang-en="Currency">Devise</label>
                                    <select class="form-select" asp-for="CurrencyId" required>
                                        <option value="" data-lang-fr="Sélectionner" data-lang-en="Select">Sélectionner</option>
                                        @foreach (var c in Model.Currencies)
                                        {
                                            <option value="@c.Id">@c.Name</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" data-lang-fr="Annuler" data-lang-en="Cancel">Annuler</button>
                                <button type="submit" class="btn btn-primary" data-lang-fr="Envoyer" data-lang-en="Submit">Envoyer</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="savProductModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" data-lang-fr="Demande SAV" data-lang-en="Support request">Demande SAV</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form method="post" asp-page-handler="CreateSavFromProduct" enctype="multipart/form-data">
                            <div class="modal-body">
                                <input type="hidden" asp-for="ProductNumber" />

                                <div class="mb-3">
                                    <label class="form-label" data-lang-fr="Nom" data-lang-en="Name">Nom</label>
                                    <input class="form-control" asp-for="SavName" required />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label" data-lang-fr="Description" data-lang-en="Description">Description</label>
                                    <textarea class="form-control" asp-for="SavDescription" rows="3"></textarea>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label" data-lang-fr="Cause de la demande" data-lang-en="Request cause">Cause de la demande</label>
                                    <select class="form-select" asp-for="SavDiagnostic">
                                        <option value="" data-lang-fr="Sélectionner une cause" data-lang-en="Select a cause">Sélectionner une cause</option>
                                        <option value="258130000" data-lang-fr="Produit défectueux" data-lang-en="Defective product">Produit défectueux</option>
                                        <option value="258130001" data-lang-fr="Produit ne fonctionne pas" data-lang-en="Product not working">Produit ne fonctionne pas</option>
                                        <option value="258130002" data-lang-fr="Autre" data-lang-en="Other">Autre</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label" data-lang-fr="Photo" data-lang-en="Photo">Photo</label>
                                    <input type="file" class="form-control" asp-for="SavPhoto" accept="image/*" />
                                    <div class="form-text text-muted" data-lang-fr="Formats acceptés : JPG, PNG, GIF (max 5MB)" data-lang-en="Accepted formats: JPG, PNG, GIF (max 5MB)">
                                        Formats acceptés : JPG, PNG, GIF (max 5MB)
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label" data-lang-fr="Date d'achat" data-lang-en="Purchase date">Date d'achat</label>
                                    <input class="form-control" asp-for="SavPurchaseDate" type="date" />
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" data-lang-fr="Annuler" data-lang-en="Cancel">Annuler</button>
                                <button type="submit" class="btn btn-danger" data-lang-fr="Envoyer" data-lang-en="Submit">Envoyer</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="mt-5">
                <div class="d-flex align-items-center justify-content-between gap-3 mb-3">
                    <h2 class="h4 fw-bold mb-0" data-lang-fr="Avis" data-lang-en="Reviews">Avis</h2>

                    @if (HttpContext.Session.GetString("IsLoggedIn") == "true")
                    {
                        if (Model.HasUserReviewed)
                        {
                            <div class="alert alert-info mb-0 py-1 px-3" role="alert">
                                <i class="fas fa-check-circle me-2"></i>
                                <span data-lang-fr="Vous avez déjà donné votre avis sur ce produit" data-lang-en="You have already reviewed this product">Vous avez déjà donné votre avis sur ce produit</span>
                            </div>
                        }
                        else
                        {
                            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addReviewModal">
                                <i class="fas fa-pen me-2"></i>
                                <span data-lang-fr="Ajouter un avis" data-lang-en="Add a review">Ajouter un avis</span>
                            </button>
                        }
                    }
                    else
                    {
                        <a class="btn btn-outline-primary" asp-page="/Login" asp-route-ReturnUrl="@($"{HttpContext.Request.Path}{HttpContext.Request.QueryString}")">
                            <i class="fas fa-pen me-2"></i>
                            <span data-lang-fr="Ajouter un avis" data-lang-en="Add a review">Ajouter un avis</span>
                        </a>
                    }
                </div>

                @if (!string.IsNullOrWhiteSpace(Model.ReviewErrorMessage))
                {
                    <div class="alert alert-danger" role="alert">
                        @Model.ReviewErrorMessage
                    </div>
                }

                @if (Model.AvisList == null || Model.AvisList.Count == 0)
                {
                    <div class="text-muted" data-lang-fr="Aucun avis pour ce produit." data-lang-en="No reviews for this product.">Aucun avis pour ce produit.</div>
                }
                else
                {
                    <div class="row row-cols-1 row-cols-md-2 g-4">
                        @foreach (var a in Model.AvisList)
                        {
                            var percent = a.Note.HasValue ? a.Note.Value * 10 : 0;
                            <div class="col">
                                <div class="card h-100 border-0 shadow-sm rounded-4">
                                    <div class="card-body p-4">
                                        <div class="d-flex align-items-start justify-content-between gap-3">
                                            <div class="flex-grow-1">
                                                <div class="fw-semibold text-truncate">@a.Title</div>
                                                @if (!string.IsNullOrWhiteSpace(a.CreatedByName) || a.CreatedOn.HasValue)
                                                {
                                                    <div class="text-muted small">
                                                        @if (!string.IsNullOrWhiteSpace(a.CreatedByName))
                                                        {
                                                            <span>@a.CreatedByName</span>
                                                        }
                                                        @if (!string.IsNullOrWhiteSpace(a.CreatedByName) && a.CreatedOn.HasValue)
                                                        {
                                                            <span> • </span>
                                                        }
                                                        @if (a.CreatedOn.HasValue)
                                                        {
                                                            <span>@a.CreatedOn.Value.ToString("dd/MM/yyyy")</span>
                                                        }
                                                    </div>
                                                }
                                            </div>

                                            <div class="flex-shrink-0">
                                                <div class="stars">
                                                    <div class="stars-filled" style="width:@percent%;"></div>
                                                </div>
                                            </div>
                                        </div>

                                        @if (!string.IsNullOrWhiteSpace(a.Description))
                                        {
                                            <div class="mt-3 text-muted">@a.Description</div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="modal fade" id="addReviewModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" data-lang-fr="Ajouter un avis" data-lang-en="Add a review">Ajouter un avis</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form method="post" asp-page-handler="AddReview">
                            <div class="modal-body">
                                <input type="hidden" asp-for="ProductNumber" />

                                <div class="mb-3">
                                    <label class="form-label" data-lang-fr="Titre" data-lang-en="Title">Titre</label>
                                    <input class="form-control" asp-for="ReviewTitle" required />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label" data-lang-fr="Description" data-lang-en="Description">Description</label>
                                    <textarea class="form-control" asp-for="ReviewDescription" rows="3"></textarea>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label" data-lang-fr="Note (0 à 10)" data-lang-en="Rating (0 to 10)">Note (0 à 10)</label>
                                    <input class="form-control" asp-for="ReviewNote" type="number" min="0" max="10" step="1" required />
                                    <div class="mt-2">
                                        <div class="stars">
                                            <div class="stars-filled" id="reviewStarsFilled" style="width:0%;"></div>
                                        </div>
                                        <div class="small text-danger" id="reviewStarsError"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" data-lang-fr="Annuler" data-lang-en="Cancel">Annuler</button>
                                <button type="submit" class="btn btn-primary" data-lang-fr="Envoyer" data-lang-en="Submit">Envoyer</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        }
    </div>
</section>

<style>
    .stars {
        position: relative;
        display: inline-block;
        font-size: 1.2rem;
        color: #ccc;
        line-height: 1;
    }

    .stars::before {
        content: "★★★★★";
    }

    .stars .stars-filled {
        position: absolute;
        top: 0;
        left: 0;
        white-space: nowrap;
        overflow: hidden;
        color: gold;
    }

    .stars .stars-filled::before {
        content: "★★★★★";
    }
</style>

<script>
    (function () {
        var noteInput = document.getElementById('ReviewNote');
        if (!noteInput) return;

        var starsFilled = document.getElementById('reviewStarsFilled');
        var error = document.getElementById('reviewStarsError');

        function updateStars() {
            var value = parseInt(noteInput.value, 10);
            error.textContent = '';

            if (isNaN(value)) {
                starsFilled.style.width = '0%';
                return;
            }

            if (value < 0 || value > 10) {
                error.textContent = 'Veuillez entrer un entier entre 0 et 10.';
                starsFilled.style.width = '0%';
                return;
            }

            var pourcentage = (value / 10) * 100;
            starsFilled.style.width = pourcentage + '%';
        }

        noteInput.addEventListener('input', updateStars);
        updateStars();
    })();
</script>

@if (HttpContext.Session.GetString("IsLoggedIn") == "true" && (HttpContext.Request.Query["openSav"].ToString() == "1"))
{
    <script>
        (function () {
            var el = document.getElementById('savProductModal');
            if (!el || !window.bootstrap) return;
            var modal = bootstrap.Modal.getOrCreateInstance(el);
            modal.show();
        })();
    </script>
}
